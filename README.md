[1. Описание основной части проекта](#описание-основной-части)

[2. Структура проекта](#структура-проекта)

[3. Описание rest api сервера](#rest-api-server)

# Описание основной части

Для запуска введите:

`docker-compose up restapiService serverService clientService1 clientService2 clientService3 clientService4 clientService5 clientService6 clientService7 clientService8 clientService9`

Можно вместо девяти клиентов запустить любое количество. Игры будут запускаться только пока на сервере есть хотя бы 4 клиента. В том числе достаточно подключить трёх клиентов таким образом и одного отдельно через `docker run` (см ниже).

При подключении клиента сервер добавляет его в сессию какой-нибудь игры, а если все сессии заполнены, то создаёт новую сессию для этого клиента (сейчас доступные количества игроков на сессию - 4 и 5).
Каждые 5 секунд (константа прописана в файле server.py) после запуска сервера он раз в секунду будет проверять, достаточно ли людей для начала игры и пытаться начать игру (для каждой сессии). После завершения предыдущей игры все подключенные юзеры будут добавлены в какую-нибудь другую сессию игры. 5 секунд нужны для того, чтобы можно было успеть остановить контейнеры между играми (иначе они просто очень быстро играют очень много игр подряд), и для того, чтобы к первой игре успели подключиться все игроки, которые хотят.

Чтобы следить за отдельным клиентом и задать ему кастомное имя, нужно запустить клиента отдельно (не через docker-compose). Для этого надо запустить следующую команду:

`docker rm my_client` - нужно, чтобы удалить контейнер с этим именем перед созданием нового. Если эта команда возвращает ошибку, что контейнера нет, это нормально (при первом запуске она так и сделает).

`docker run --env SERVER_ADDRESS=serverService:5075 --env CLIENT_ADDRESS=my_client:6000 --env CLIENT_PORT=6000 --env USERNAME=yulicheck --network soa_homework_2_default --name my_client client_image`

Здесь мы передаём все необходимые переменные окружения (особое внимание на USERNAME - через него можно задать кастомное имя), подключаемся к сети, к которой подключается docker-compose (по крайней мере, у меня на ноутбуке, и я очень надеюсь, что не только). *Эту команду надо запускать после того, как сервер уже запущен*. Клиент подключится к следующей игре (если игра уже началась, он будет получать уведомления, но не сможет выполнять действия, как мёртвый).

*Enjoy*

Замечания по выбору имени - на сервере есть некоторый пул рандомных имён, которые выдаются пользователям, которые не выбирают имя (соответствующее поле - optional), или которые выбирают уже занятое имя. Например, рандомные имена выдаются всем ботам, запускающимся через docker-compose.

# Структура проекта

У клиента и у сервера есть по grpc-серверу. Сервер клиента однопоточный, сервер сервера многопоточный. Сервер клиента поддерживает список игроков, подключённых к серверу, для этого у него вызываются методы NotifyLeave и NotifyJoin. Раз в секунду вызывается метод Ping для проверки того, не отключился ли пользователь. Внутриигровые уведомления отсылаются при помощи метода GameNotify, а при помощи специального метода GiveActionOptions пользователю присылаются действия, которые он должен выполнить. После этого пользователь может потратить сколько угодно времени на то, чтобы прислать ответ (но в реализации ботов они присылают ответ даже до того, как отвечают на GiveActionOptions, чтобы не нарушать их однопоточность).

Файл mafia.py отвечает за всю логику игры и предоставление уведомлений, которые нужно рассылать игрокам. Для уведомлений есть методы take_notification и take_await_actions, которые нужны для того, чтобы сервер рассылал уведомления и опрашивал игроков об их дальнейших действиях.

Логика игры описывается условием задачи. Все действия описываются некоторым голосованием, а именно, мафия голосует за то, кого убить, полицейские голосуют за то, кого проверить, днём все голосуют за то, кого повесить. Игрок может вызвать метод Sleep днём и заснуть (до голосования, в таком случае он его пропускает, или после голосования), или аналогичный метод Wake ночью. Игрок может несколько раз звать метод Vote/Kill/Check, будет считаться, что игрок изменил решение и переголосовал.  Все голосования различаются перед началом следующего времени суток (то есть днём - когда все лягут спать, ночью - когда все проснутся), затем начинается новое время суток, всем приходит соответствующее уведомление и все начинают предпринимать свои внутриигровые действия.

**Безопасность**
Каждый игрок "авторизуется" своим адресом. Для того чтобы делать действия, он должен указывать свой адрес. Каждый игрок видит имена всех игроков, но не адреса, поэтому это "безопасно". Действие, присланное игроком, проверяется на то, разрешено ли оно (боты всегда выполняют только разрешённые действия). Если оно не разрешено, в ответ на действие присылается специальное сообщение с соответствующим кодом (`messages.ActionResult.Status.NotAllowed`). Если игрок перестаёт отвечать на пинги, он отключается и всем игрокам приходит об этом уведомление.

У класса Server и класса GameState есть мьютексы, которыми они защищаются от Race Condition.

Комментарий: я так и не понял, обязательное ли это требование, но все картинки выложены в docker hub (https://hub.docker.com/repository/docker/yulikdaniel/mafia_client, https://hub.docker.com/repository/docker/yulikdaniel/mafia_server) и подтягиваются оттуда в docker-compose.

# Rest api server

Код для запуска рест апи сервера уже включён в описание основной части выше.

Сервер поддерживает базу данных клиентов с метаинформацией про их имя, электронную почту, возраст, информацию об их играх и аватарку. Взаимодействие с сервером происходит при помощи POST и PUT запросов (и GET для просмотра сгенерированного отчёта). Для добавления нового пользователя нужно выполнить 
`curl -i -X POST -H "Content-Type: application/json" -d '{"email":"lala@la.la", "age":1543}' http://127.0.0.1:15430/users/<username>`

База данных индексируется именем, если такой пользователь уже есть, ничего не произойдёт. Тот же код с PUT выполнит обновление данных пользователя. Для установки аватарки нужно выполнить
`curl -i -X POST -F avatar=@/home/user/Pictures/picture.png http://127.0.0.1:15430/users/avatar/<username>`

Для генерации профиля пользователя достаточно выполнить `curl -i -X POST http://127.0.0.1:15430/reports/<username>` и затем перейти по ссылке, которая будет возвращена по этому запросу (по ней отдельный поток асинхронно сгенерирует пдфку).

Создание профиля с почтой и возрастом осуществляется автоматически основным игровым сервером, как и обновление данных об играх.

Прошу заметить, что при последовательных запусках `up` база данных не пересоздаётся, поэтому данные пользователей сохраняются. Если вы хотите сбросить данные пользователей, удалите старый контейнер или запускайте `up` с соответствущим флагом.